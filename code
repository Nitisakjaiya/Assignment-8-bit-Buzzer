#include <Arduino.h>

#define BUZZER_PIN 25
#define BUTTON_PIN 35

hw_timer_t *timer = NULL;
volatile bool buzzerState = false;
volatile bool buttonPressed = false;

// ===== Frequencies (Octave 6) =====
#define NOTE_C6  1047
#define NOTE_D6  1175
#define NOTE_E6  1319
#define NOTE_G6  1568

int melody[] = {
  NOTE_C6, NOTE_D6, NOTE_E6, NOTE_G6,
  NOTE_G6, NOTE_E6, NOTE_D6, NOTE_C6
};

int melodyLength = 8;
int noteIndex = 0;

// Speed levels
int speedLevel = 2;
int speedFactor[5] = {200, 150, 100, 70, 40};

// ===== Timer ISR =====
void IRAM_ATTR onTimer() {
  buzzerState = !buzzerState;
  digitalWrite(BUZZER_PIN, buzzerState);
}

// ===== Button ISR =====
void IRAM_ATTR onButton() {
  buttonPressed = true;
}

void setup() {
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(BUTTON_PIN, INPUT_PULLUP);

  attachInterrupt(BUTTON_PIN, onButton, FALLING);


  timer = timerBegin(1000000);

  timerAttachInterrupt(timer, &onTimer);
}

void loop() {
  if (buttonPressed) {
    speedLevel = (speedLevel + 1) % 5;
    buttonPressed = false;
  }

  int freq = melody[noteIndex];

 
  uint32_t halfPeriod = 1000000 / (freq * 2);


  timerAlarm(timer, halfPeriod, true, 0);
  timerStart(timer);

  delay(speedFactor[speedLevel]);

  timerStop(timer);
  digitalWrite(BUZZER_PIN, LOW);

  noteIndex++;
  if (noteIndex >= melodyLength) noteIndex = 0;
}
